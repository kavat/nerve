<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>NERVE</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link href={{ url_for('static', filename="vendor/bootstrap4/css/bootstrap.min.css") }}  rel="stylesheet">
    <link href={{ url_for('static', filename="vendor/toastr/toastr.min.css") }}  rel="stylesheet">
    <link href={{ url_for('static', filename="css/nerve.css") }}  rel="stylesheet">
    <link href={{ url_for('static', filename="css/master.css") }}  rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <div id="sidebar">{% include 'sidebar.html' %}</div>

            <div id="body">
                <nav class="navbar navbar-expand-lg navbar-primary bg-primary">
                    <button type="button" id="sidebarCollapse" class="btn btn-outline-light default-light-menu"><i class="fas fa-bars"></i><span></span></button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="nav navbar-nav ml-auto">
                          {% include 'headbar.html' %}
                        </ul>
                    </div>
                </nav>

            <div class="content">
              <div class="container-fluid">
                  <div class="page-title">
                      <h3>Assessment</h3>
                  </div>
                  <div class="box box-primary">
                      <div class="box-body">
                          <ul class="nav nav-tabs" id="myTab" role="tablist">
                              <li class="nav-item">
                                  <a class="nav-link active" id="general-tab" data-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true">General</a>
                              </li>
                              <li class="nav-item">
                                  <a class="nav-link" id="targets-tab" data-toggle="tab" href="#targets" role="tab" aria-controls="targets" aria-selected="false">Targets</a>
                              </li>
                              <li class="nav-item">
                                  <a class="nav-link" id="config-tab" data-toggle="tab" href="#config" role="tab" aria-controls="config" aria-selected="false">Configuration</a>
                              </li>
                              <li class="nav-item">
                                  <a class="nav-link" id="dictionary-tab" data-toggle="tab" href="#dictionary" role="tab" aria-controls="dictionary" aria-selected="false">Dictionary</a>
                              </li>
                              <li class="nav-item">
                                <a class="nav-link" id="schedule-tab" data-toggle="tab" href="#schedule" role="tab" aria-controls="schedule" aria-selected="false">Schedule</a>
                            </li>
                              <li class="nav-item">
                                <a class="nav-link" id="post_event-tab" data-toggle="tab" href="#post_event" role="tab" aria-controls="post_event" aria-selected="false">Post Event</a>
                            </li>
                          </ul>

                          <div class="tab-content" id="myTabContent">
                              <div class="tab-pane fade active show" id="general" role="tabpanel" aria-labelledby="general-tab">
                                  <div class="col-md-6">
                                      <div class="form-group">
                                          <label for="title" class="form-control-label">Assessment Title <i><span class="required">Required</span></i></label>
                                          <input type="text" id="title" name="title" class="form-control">
                                      </div>
                                      <div class="form-group">
                                          <label for="description" class="form-control-label">Assessment Description</label>
                                          <textarea class="form-control" id="description" name="description"></textarea>
                                      </div>
                                      <div class="form-group">
                                        <label for="engineer" class="form-control-label">Name of Engineer </label>
                                        <input type="text" name="engineer" id="engineer" class="form-control">
                                    </div>
                              </div>
                            </div>


                              <div class="tab-pane fade" id="targets" role="tabpanel" aria-labelledby="targets-tab">
                                  <div class="col-md-6">
                                    <p class="text-muted">Specify either Networks, Domains, or both.<br>
                                    </p>
                                    <p class="mb-0"><strong>Targets</strong> <span class="required">Required</span></p>
                                      <div class="form-group">
                                          <label for="networks" class="form-control-label">Networks</i></label>
                                          <input type="text" id="networks" name="networks" class="form-control" placeholder="192.168.0.0/24, 192.168.1.0/24">
                                      </div>


                                      <div class="form-group">
                                        <label for="domains" class="form-control-label">Domains</i></label>
                                        <input type="text" id="domains" name="domains" class="form-control" placeholder="sub1.domain.com,sub2.domain.com">
                                    </div>

                                    <p class="mb-0"><strong>Exclusion</strong></p>
                                    <div class="form-group">
                                        <label for="exc_networks" class="form-control-label">Excluded Networks <i></i></label>
                                        <input type="text" id="exc_networks" name="exc_networks" placeholder="192.168.0.10/32, 192.168.10.0/24" class="form-control">
                                    </div>

                                  </div>
                              </div>
                              <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">

                                <div class="col-md-6">

                                  <label for="" class="form-control-label"><b>Assessment Configuration</b></label><br><br>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Enable Network Scan</label>
                                    <div class="custom-control custom-switch">
                                      <input type="checkbox" onclick='display_data("network");' class="custom-control-input" name="network_scan_enable" id="network_scan_enable">
                                      <label class="custom-control-label" for="network_scan_enable"></label>
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Enable CVE Scan</label>
                                    <div class="custom-control custom-switch">
                                      <input type="checkbox" onclick='display_data("cve");' class="custom-control-input" name="cve_scan_enable" id="cve_scan_enable">
                                      <label class="custom-control-label" for="cve_scan_enable"></label>
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Enable Inspec Scan</label>
                                    <div class="custom-control custom-switch">
                                      <input type="checkbox" onclick='display_data("inspec");' class="custom-control-input" name="inspec_scan_enable" id="inspec_scan_enable">
                                      <label class="custom-control-label" for="inspec_scan_enable"></label>
                                    </div>
                                  </div>

                                  <div id="cve_settings" style="display:none;">
                                  <label for="" class="form-control-label"><b>CVE Scan Configuration</b></label><br><br>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                      <label for="" class="form-control-label">Username for CVE Scan (SSH)</label>
                                      <input type="text" class="form-control" name="cve_username_ssh" id="cve_username_ssh placeholder="username">
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Password for CVE Scan (SSH)</label>
                                      <input type="text" class="form-control" name="cve_password_ssh" id="cve_password_ssh placeholder="password">
                                    </div>
                                  </div>                                       
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Type of OS packages</label>
                                      <select id='package_type' name='package_type'>
                                        <option value=''></option>
                                        <option value='rpm'>RPM</option>
                                        <option value='deb'>DEB</option>
                                      </select>
                                    </div>
                                  </div>
                                  </div>

                                  <div id="inspec_settings" style="display:none;">
                                  <label for="" class="form-control-label"><b>Inspec Scan Configuration</b></label><br><br>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Username for Inspec Scan (SSH)</label>
                                      <input type="text" class="form-control" name="inspec_username_ssh" id="inspec_username_ssh placeholder="username">
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Password for Inspec Scan (SSH)</label>
                                      <input type="text" class="form-control" name="inspec_password_ssh" id="inspec_password_ssh placeholder="password">
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Host OS</label>
                                      <select id='os_inspec' name='os_inspec'>
                                        <option value=''></option>
                                        <option value='linux'>Linux</option>
                                        <option value='windows'>Windows</option>
                                      </select>
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <div class="custom-control custom-switch">
                                    <label for="" class="form-control-label">Profile to run</label>
                                      <select id='profile_inspec' name='profile_inspec'>
                                        <option value=''></option>
                                        <option value='devsec/linux-baseline'>Linux baseline</option>
                                        <option value='devsec/windows-baseline'>Windows baseline</option>
                                        <option value='devsec/cis-dil-benchmark'>CIS benchmark (Linux)</option>
                                      </select>
                                    </div>
                                  </div>
                                  </div>

                                    <div id="network_settings" style="display:none;">     
                                  <label for="" class="form-control-label"><b>Network Scan Configuration</b></label><br><br>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Enable Internal Network Scan</label>
                                    <div class="custom-control custom-switch">
                                      <input type="checkbox" class="custom-control-input" name="network_scan_type" id="network_scan_type">
                                      <label class="custom-control-label" for="network_scan_type"></abel>
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Username for Internal Scan (SSH)</label>
                                    <div class="custom-control custom-switch">
                                      <input type="text" class="form-control" name="network_username_ssh" id="network_username_ssh placeholder="username">
                                    </div>
                                  </div>
                                  <div class="form-group">
                                    <label for="" class="form-control-label">Password for Internal Scan (SSH)</label>
                                    <div class="custom-control custom-switch">
                                      <input type="text" class="form-control" name="network_password_ssh" id="network_password_ssh placeholder="password">
                                    </div>
                                  </div>
                                      <label for="" class="form-control-label">Aggressiveness Level</label>
                                      <div class="form-group">
                                        <select id="aggressive_level" name="aggressive_level" class="form-control">
                                            <option value="3">Extremely Aggressive (Default)</option>
                                            <option value="2">Aggressive</option>
                                            <option value="1">Mildly Aggressive</option>
                                            <option value="0">Gentle</option>
                                        </select>
                                    </div>
                                      <div class="form-group">
                                        <label for="" class="form-control-label">Allow Outbound Internet Connections</label>
                                        <div class="custom-control custom-switch">
                                          <input type="checkbox" class="custom-control-input" name="attempt_0" id="attempt_0">
                                          <label class="custom-control-label" for="attempt_0"></label>
                                      </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="" class="form-control-label">Attempt Brute Force Attacks</label>
                                        <div class="custom-control custom-switch">
                                          <input type="checkbox" class="custom-control-input" name="attempt_3" id="attempt_3">
                                          <label class="custom-control-label" for="attempt_3"></label>
                                      </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="" class="form-control-label">Attempt Denial of Service Attacks</label>

                                        <div class="custom-control custom-switch">
                                          <input type="checkbox" class="custom-control-input" name="attempt_1" id="attempt_1">
                                          <label class="custom-control-label" for="attempt_1"></label>
                                      </div>
                                    </div>

                                      <label for="" class="form-control-label"><b>Port Scanning Options</b></label>
                                      <div class="form-group">
                                        <div class="form-group">
                                            <label for="" class="form-control-label">Ethernet</label>
                                            <input type="text" id="interface" name="interface" placeholder="eth0" class="form-control">
                                            <small class="text-muted">Uses default if not specified</small>
                                        </div>
                                      </div>
                                      <div class="form-group">
                                          <label for="" class="form-control-label">Maximum Ports</label>
                                          <select name="max_ports" id="max_ports" class="form-control">
                                            <option value="10">10</option>
                                            <option value="100" selected>100</option>
                                            <option value="500">500</option>
                                            <option value="1000">1000</option>
                                            <option value="2000">2000</option>
                                            <option value="3000">3000</option>
                                            <option value="4000">4000</option>
                                            <option value="5000">5000</option>
                                            <option value="10000">10,000</option>
                                            <option value="30000">30,000</option>
                                            <option value="40000">40,000</option>
                                            <option value="50000">50,000</option>
                                            <option value="65535">All Ports (EXTREMELY slow.)</option>
                                          </select>
                                          <small class="text-muted">1000 = one thousand most commonly used ports</small>
                                      </div>
                                      <div class="form-group">
                                        <label for="" class="form-control-label">Custom Ports</label>
                                        <input type="text" id="custom_ports" name="custom_ports" class="form-control" placeholder="20,21,22,80,443,8443">
                                        <small class="text-muted">Comma separated integers. Takes presedence over <b>MAX_PORTS</b>.</small>

                                    </div>
                                      <div class="form-group">
                                          <label for="parallel_scans" class="form-control-label">Parallel Scan</label>
                                          <select name="parallel_scans" id="parallel_scans" class="form-control">
                                              <option value="10">10</option>
                                              <option value="30">30</option>
                                              <option value="50" selected>50</option>
                                              <option value="100">100</option>
                                          </select>
                                      </div>
                                      <div class="form-group">
                                          <label for="parallel_attack" class="form-control-label">Parallel Attack</label>
                                          <select name="parallel_attack" id="parallel_attack" class="form-control">
                                            <option value="10">10</option>
                                            <option value="30" selected>30</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                          </select>
                                      </div>
                                    </div> <!-- FINE -->
                                  </div>
                              </div>
                              

                              <div class="tab-pane fade" id="dictionary" role="tabpanel" aria-labelledby="dictionary-tab">
                                <div class="col-md-6">
                                <p class="text-muted">Add your preferred word lists to be used in Brute Force attacks.<br>
                                    <b>Note:</b> If no dictionary is specified, a built in dictionary will be used.
                                </p>
                                <label for="" class="form-control-label"><b>Brute Force</b></label>
                                <div class="form-group">
                                  <label class="form-control-label">Usernames</label>
                                  <textarea class="form-control" id="usernames" name="usernames" placeholder="Paste your list here" rows="6"></textarea>
                                  <small class="text-muted">Separate the usernames with a new line.</small><br>
                              </div>
                              <div class="form-group">
                                  <label class="form-control-label">Passwords</i></label>
                                  <textarea class="form-control" id="passwords" name="passwords" placeholder="Paste your list here" rows="6"></textarea>
                                  <small class="text-muted">Separate the passwords with a new line.</small><br>
                              </div>
                                </div>
                              </div>

                              <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                                <div class="col-md-6">
                                    <label for="" class="form-control-label"><b>Assessment Schedule</b></label>
                                    <div class="form-group">
                                      <select id="frequency" name="frequency" class="form-control">
                                          <option value="once" selected>Run Once</option>
                                          <option value="continuous">Run Continuously</option>
                                      </select>
                                      <small class="text-muted">* Running continuously will not stop until you reset the system</small><br>
                                  </div>

                                </div>
                            </div>

                              <div class="tab-pane fade" id="post_event" role="tabpanel" aria-labelledby="post_event-tab">
                                <div class="col-md-6">
                                <div class="form-group">
                                  <label for="engineer" class="form-control-label">Webhook </label>
                                  <input type="text" name="webhook" id="webhook" class="form-control" placeholder="https://notify.example.com/receive">
                                  <small class="text-muted">Calls back at the end of the assessment with relevant data (JSON POST)</small>
                              </div>
                            </div>
                              </div>

                          </div>

                          <div class="form-group text-right">
                            <button class="btn btn-info" type="submit" onclick="submit_assessment();"> <i class="fas fa-check"></i> Run Assessment</button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
        </div>
    </div>


    <script src= {{ url_for('static', filename="vendor/jquery3/jquery-3.4.1.min.js") }}></script>
    <script src= {{ url_for('static', filename="vendor/bootstrap4/js/bootstrap.bundle.min.js") }}></script>
    <script src= {{ url_for('static', filename="vendor/fontawesome5/js/solid.min.js") }}></script>
    <script src= {{ url_for('static', filename="vendor/fontawesome5/js/fontawesome.min.js") }}></script>
    <script src= {{ url_for('static', filename="vendor/toastr/toastr.min.js") }}></script>
    <script src= {{ url_for('static', filename="js/script.js") }}></script>

    {% with messages = get_flashed_messages(with_categories=true) %}
     {% if messages %}
        <script>
        {% for category, message in messages %}
        toastr.{{category}}("{{ message }}");
        {% endfor %}
        </script>
     {% endif %}
    {% endwith %}

    <script>
        $(function() {
        $('#approach').change(function(){
            $('.approaches').hide();
            $('#' + $(this).val()).show();
        });
    });
    </script>

    <script>
        function trim_whitespace(text){
            return text.replace(/\s+/g, '');
        }

        function display_data(prefix){
          if(document.getElementById(prefix + '_scan_enable').checked){
            if(prefix == "network"){
              document.getElementById('cve_settings').style.display = 'none';
              document.getElementById('inspec_settings').style.display = 'none';
              document.getElementById('cve_scan_enable').checked = false;
              document.getElementById('inspec_scan_enable').checked = false;
            }
            if(prefix == "cve"){
              document.getElementById('network_settings').style.display = 'none';
              document.getElementById('inspec_settings').style.display = 'none';
              document.getElementById('network_scan_enable').checked = false;
              document.getElementById('inspec_scan_enable').checked = false;
            }
            if(prefix == "inspec"){
              document.getElementById('cve_settings').style.display = 'none';
              document.getElementById('network_settings').style.display = 'none';
              document.getElementById('cve_scan_enable').checked = false;
              document.getElementById('network_scan_enable').checked = false;
            }
            document.getElementById(prefix + '_settings').style.display = 'block';
          }
          else{
            document.getElementById(prefix + '_settings').style.display = 'none';
          }
        }

        function submit_assessment(){
            var networks = []
            var exc_networks = []
            var domains = []
            var users = []
            var passwords = []
            var webhook = null
            var title = document.getElementById("title").value
            var description = document.getElementById("description").value
            var engineer = document.getElementById("engineer").value
            var scan_type = ""
            var network_scan_type = "external"
            var username_ssh = ""
            var password_ssh = ""
            var package_type = ""
            var os_inspec = ""
            var profile_inspec = ""

            var frequency = 'once'
            var aggressive_level = 3
            var dos = true
            var outbound = true
            var bruteforce = true;
            var net_interface = null
            var max_ports = 100
            var custom_ports = []
            var parallel_scans = 10
            var parallel_attack = 10

            if(document.getElementById("network_scan_enable")) {
              if(document.getElementById("network_scan_enable").checked) {
                scan_type = "nmap"
                if(document.getElementById("network_scan_type").checked) {
                  username_ssh = document.getElementById("network_username_ssh").value
                  password_ssh = document.getElementById("network_password_ssh").value
                }
              }
            }

            if(document.getElementById("cve_scan_enable")) {
              if(document.getElementById("cve_scan_enable").checked) {
                scan_type = "cve"
                username_ssh = document.getElementById("cve_username_ssh").value
                password_ssh = document.getElementById("cve_password_ssh").value
              }
            }

            if(document.getElementById("inspec_scan_enable")) {
              if(document.getElementById("inspec_scan_enable").checked) {
                scan_type = "inspec"
                username_ssh = document.getElementById("inspec_username_ssh").value
                password_ssh = document.getElementById("inspec_password_ssh").value
              }
            }

            if(scan_type == "") {
              toastr.warning("Scan type must be set.")
              return;
            }

            if(document.getElementById("network_scan_type").checked) {
              network_scan_type = "internal"
            }

            if(scan_type == "cve" || scan_type == "inspec" || (scan_type == "nmap" && network_scan_type == "internal")) {
              if(username_ssh == "" || password_ssh == "") {
                toastr.warning("Username and password cannot be empty for this type of scan.")
                return;
              }
            }

            if(document.getElementById("package_type")) {
              package_type = document.getElementById("package_type").value
            }

            if(title == '') {
                toastr.warning("Assessment title must be set.")
                return;
            }

            if(title.length > 30){
                toastr.warning("Assessment title must not exceed 30 characters")
                return;
            }

            if(description != '' && description.length > 200){
                toastr.warning("Assessment description must not exceed 200 characters.")
                return;
            }

            if(engineer != '' && engineer.length > 20){
                toastr.warning("Engineer name must not exceed 20 characters.")
                return;
            }

            if(document.getElementById("webhook").value){
                webhook = document.getElementById("webhook").value
            }

            if(document.getElementById("frequency").value){
                frequency = document.getElementById("frequency").value
            }

            var u_networks = document.getElementById("networks")
            if (u_networks && u_networks.value != ''){
                networks = trim_whitespace(u_networks.value).split(",")
            }

            var u_exc_networks = document.getElementById("exc_networks")
            if (u_exc_networks && u_exc_networks.value != ''){
                exc_networks = trim_whitespace(u_exc_networks.value).split(",")
            }

            var u_domains = document.getElementById("domains")
            if (u_domains && u_domains.value != ''){
                domains = trim_whitespace(u_domains.value).split(",")
            }

            if (domains.length == 0 && networks.length == 0){
                toastr.warning("Networks or Domains must be defined.")
                return;
            }

            var e = document.getElementById("aggressive_level");
            if (e){
                aggressive_level = parseInt(e.options[e.selectedIndex].value)
            }

            if (document.getElementById("attempt_0")){
                outbound = document.getElementById("attempt_0").checked
            }

            if (document.getElementById("attempt_1")){
                dos = document.getElementById("attempt_1").checked
            }

            if (document.getElementById("attempt_3")) {
                bruteforce = document.getElementById("attempt_3").checked
            }


            if (document.getElementById("interface")){
                net_interface = document.getElementById("interface").value
            }

            if (document.getElementById("max_ports")){
                max_ports = parseInt(document.getElementById("max_ports").value)
            }

            var u_custom_ports = document.getElementById("custom_ports")
            if (u_custom_ports && u_custom_ports.value != ''){
                custom_ports = trim_whitespace(u_custom_ports.value).split(",").map(Number);
            }

            var e = document.getElementById("parallel_scans");
            if (e){
                parallel_scans = parseInt(e.options[e.selectedIndex].value)
            }

            var e = document.getElementById("parallel_attack");
            if (e){
                parallel_attack = parseInt(e.options[e.selectedIndex].value)
            }

            var u_usernames = document.getElementById("usernames")
            if (u_usernames && u_usernames.value != ''){
                users = u_usernames.value.split("\n")
            }

            var u_passwords = document.getElementById("passwords")
            if (u_passwords && u_passwords.value != '') {
                passwords = u_passwords.value.split("\n")
            }

            var data = {
                'type':scan_type,
                'username_ssh':username_ssh,
                'password_ssh':password_ssh,
                'type_ie':network_scan_type,
                'how':'automatic',
                'package_type':package_type,
                'os_inspec':os_inspec,
                'profile_inspec':profile_inspec,
                'targets':{
                    'networks':networks,
                    'excluded_networks':exc_networks,
                    'domains':domains
                },
                'config':{
                    'name':title,
                    'description':description,
                    'engineer':engineer,
                    'allow_aggressive':aggressive_level,
                    'allow_dos':dos,
                    'allow_bf':bruteforce,
                    'allow_internet':outbound,
                    'dictionary':{
                    'usernames':users,
                    'passwords':passwords
                    },
                    'scan_opts':{
                        'interface':net_interface,
                        'max_ports':max_ports,
                        'custom_ports':custom_ports,
                        'parallel_scan':parallel_scans,
                        'parallel_attack':parallel_attack,
                    },
                    'post_event':{
                    'webhook':webhook
                    },
                    'frequency':frequency
                }
                }

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState === 4 && this.status == 200) {
                    var resp = JSON.parse(this.responseText);
                    toastr.success(resp.status);
                    setTimeout(() => {
                        window.location = "/dashboard";
                     }, 3000);
                }
                else if (this.readyState === 4 && this.status != 200) {
                    var resp = JSON.parse(this.responseText);
                    toastr.error(resp.status);
                }
            };
            xhttp.open("POST", "/scan", true);
            xhttp.withCredentials = true;
            xhttp.setRequestHeader("Content-Type", "application/json");
            xhttp.send(JSON.stringify(data))
            return true;
        }

    </script>
</body>
</html>
